{
  "Resources": {
    "GameDayBastionHostInstanceRole0AD4F912": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Statement": [
            {
              "Action": "sts:AssumeRole",
              "Effect": "Allow",
              "Principal": {
                "Service": "ec2.amazonaws.com"
              }
            }
          ],
          "Version": "2012-10-17"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "GameDayBastionHost"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "GameDayBastionStack/GameDayBastionHost/Resource/InstanceRole/Resource"
      }
    },
    "GameDayBastionHostInstanceRoleDefaultPolicy283DDF41": {
      "Type": "AWS::IAM::Policy",
      "Properties": {
        "PolicyDocument": {
          "Statement": [
            {
              "Action": [
                "ssmmessages:*",
                "ssm:UpdateInstanceInformation",
                "ec2messages:*"
              ],
              "Effect": "Allow",
              "Resource": "*"
            }
          ],
          "Version": "2012-10-17"
        },
        "PolicyName": "GameDayBastionHostInstanceRoleDefaultPolicy283DDF41",
        "Roles": [
          {
            "Ref": "GameDayBastionHostInstanceRole0AD4F912"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "GameDayBastionStack/GameDayBastionHost/Resource/InstanceRole/DefaultPolicy/Resource"
      }
    },
    "GameDayBastionHostInstanceProfile78E0777E": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Roles": [
          {
            "Ref": "GameDayBastionHostInstanceRole0AD4F912"
          }
        ]
      },
      "Metadata": {
        "aws:cdk:path": "GameDayBastionStack/GameDayBastionHost/Resource/InstanceProfile"
      }
    },
    "GameDayBastionHost4427903E": {
      "Type": "AWS::EC2::Instance",
      "Properties": {
        "AvailabilityZone": "us-west-2a",
        "IamInstanceProfile": {
          "Ref": "GameDayBastionHostInstanceProfile78E0777E"
        },
        "ImageId": {
          "Ref": "SsmParameterValueawsserviceamiamazonlinuxlatestamzn2amihvmx8664gp2C96584B6F00A464EAD1953AFF4B05118Parameter"
        },
        "InstanceType": "t3.nano",
        "SecurityGroupIds": [
          {
            "Fn::ImportValue": "GameDaySecurityStack:ExportsOutputFnGetAttBastionSecurityGroupDAB89EBDGroupId0F2FE988"
          }
        ],
        "SubnetId": {
          "Fn::ImportValue": "GameDayVpcStack:ExportsOutputRefgamedayvpcpublicSubnet1Subnet53F321F82000CD21"
        },
        "Tags": [
          {
            "Key": "Name",
            "Value": "GameDayBastionHost"
          }
        ],
        "UserData": {
          "Fn::Base64": "#!/bin/bash"
        }
      },
      "DependsOn": [
        "GameDayBastionHostInstanceRoleDefaultPolicy283DDF41",
        "GameDayBastionHostInstanceRole0AD4F912"
      ],
      "Metadata": {
        "aws:cdk:path": "GameDayBastionStack/GameDayBastionHost/Resource/Resource"
      }
    },
    "CDKMetadata": {
      "Type": "AWS::CDK::Metadata",
      "Properties": {
        "Analytics": "v2:deflate64:H4sIAAAAAAAA/0WNzQrCMBCEn8V7utoq6FkvCoKlPoDEdAvbpokkG38IeXdtS/E033wMTAH5FlYL+fKZqrtM0x3ilaXqxE/dIqoC4l56JmuO1vOZTHiLk/EsjUJxaMzMSZDsIVZWj3rM0mpSn6H+ad6XzjakMaVBXgI/Ao9D6WSPjE5U6G1w08nMSRhbI7R++cw3kO9gvWg9UeaCYeoRqim/ZuC3ctUAAAA="
      },
      "Metadata": {
        "aws:cdk:path": "GameDayBastionStack/CDKMetadata/Default"
      }
    }
  },
  "Outputs": {
    "GameDayBastionHostBastionHostId3A70D9BC": {
      "Description": "Instance ID of the bastion host. Use this to connect via SSM Session Manager",
      "Value": {
        "Ref": "GameDayBastionHost4427903E"
      }
    },
    "BastionhostId": {
      "Description": "ID del bastion",
      "Value": {
        "Ref": "GameDayBastionHost4427903E"
      },
      "Export": {
        "Name": "bastion-instance-id"
      }
    },
    "CreateSshKeyCommand": {
      "Value": "ssh-keygen -t rsa -f my_rsa_key"
    },
    "PushSshKeyCommand": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "aws ec2-instance-connect send-ssh-public-key --region ",
            {
              "Ref": "AWS::Region"
            },
            " --instance-id ",
            {
              "Ref": "GameDayBastionHost4427903E"
            },
            " --availability-zone ",
            {
              "Fn::GetAtt": [
                "GameDayBastionHost4427903E",
                "AvailabilityZone"
              ]
            },
            " --instance-os-user ec2-user --ssh-public-key file://my_rsa_key.pub --profile gameday"
          ]
        ]
      }
    },
    "SshCommand": {
      "Value": {
        "Fn::Join": [
          "",
          [
            "ssh -o \"IdentitiesOnly=yes\" -i my_rsa_key ec2-user@",
            {
              "Fn::GetAtt": [
                "GameDayBastionHost4427903E",
                "PublicDnsName"
              ]
            }
          ]
        ]
      }
    }
  },
  "Parameters": {
    "SsmParameterValueawsserviceamiamazonlinuxlatestamzn2amihvmx8664gp2C96584B6F00A464EAD1953AFF4B05118Parameter": {
      "Type": "AWS::SSM::Parameter::Value<AWS::EC2::Image::Id>",
      "Default": "/aws/service/ami-amazon-linux-latest/amzn2-ami-hvm-x86_64-gp2"
    },
    "BootstrapVersion": {
      "Type": "AWS::SSM::Parameter::Value<String>",
      "Default": "/cdk-bootstrap/hnb659fds/version",
      "Description": "Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]"
    }
  },
  "Rules": {
    "CheckBootstrapVersion": {
      "Assertions": [
        {
          "Assert": {
            "Fn::Not": [
              {
                "Fn::Contains": [
                  [
                    "1",
                    "2",
                    "3",
                    "4",
                    "5"
                  ],
                  {
                    "Ref": "BootstrapVersion"
                  }
                ]
              }
            ]
          },
          "AssertDescription": "CDK bootstrap stack version 6 required. Please run 'cdk bootstrap' with a recent version of the CDK CLI."
        }
      ]
    }
  }
}